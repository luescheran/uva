This is a simple topological sorting problem (Tarjan's).

The output is not unique and needs a special corrector to judge properly.
